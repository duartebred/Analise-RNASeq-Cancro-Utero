---
title: "Carcinoma do endométrio do corpo uterino"
author: "Duarte Velho(pg53841), Joana Lopes(pg53498), João Ferreira(pg52182), Ricardo Oliveira(pg53501)"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    css: styles.css 
  pdf_document: default
encoding: "UTF-8"
editor_options:
  markdown:
    wrap: sentence
---

```{r setup, include=FALSE, warning = FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1ª Parte

## Instalação e importação de packages

Nesta secção são destacados todos os packages empregados no relatório, que facilitam a aquisição e análise de dados, ao longo do documento, tornando mais simples a obtenção e compreensão das informações relevantes.

```{r, results='hide', warning = FALSE, message=FALSE, warning = FALSE, message=FALSE}

# NOTA, confirmar no final todos os packages usados
#install.packages("BiocManager")
#install.packages("jpeg")
#install.packages("TCGAbiolinks")
#install.packages("Biobase")
#install.packages("DESeq2")
#install.packages("ggbeeswarm")
#install.packages("genefilter")
#install.packages("pheatmap")
#install.packages("org.Hs.eg.db")
#install.packages("fgsea")
#install.packages("ggplot2")
#install.packages("xfun")
#install.packages("SummarizedExperiment") 
#install.packages("factoextra")
#install.packages("Rtsne")
#install.packages("EBImage")
```

```{r,results='hide', warning = FALSE, message=FALSE,warning = FALSE, message=FALSE}

# NOTA, confirmar no final todos os packages usados
library("jpeg")
library("TCGAbiolinks")
library("SummarizedExperiment")
#library("DESeq2")
#library("Biobase")
#library("DESeq2")
#library("ggbeeswarm")
#library("pheatmap")
#library("org.Hs.eg.db")
#library("fgsea")
#library("ggplot2")
#library("factoextra")
#library("limma")
#library("genefilter")
#library("Rtsne")
#library("party")
#library("rpart")
#library("caret") 
#library("rsample")

```

## 1.Introdução -

### 1.1 Contextualização

Nos dias de hoje, o cancro é uma das principais causas de morte a nível mundial, sendo que, segundo a Organização Mundial da Saúde (OMS), em 2020, foram diagnosticados cerca de 19,3 milhões de novos casos de cancro, que resultaram na morte, de aproximadamente 10 milhões de pessoas [1].
O preocupante aumento da incidência do cancro ao longo das ultimas décadas levou ao surgimento de iniciativas, tal como a PanCancer Atlas, que visam encontrar respostas para as grandes e abrangentes questões sobre o cancro, através da análise de tumores caracterizados no conjunto de dados resultantes do projeto de The Cancer Genome Atlas (TCGA).
O TCGA é um programa de genómica de referência na área do cancro que, em colaboração com o Instituto Nacional do Cancro (NCI) e o Instituto Nacional de Pesquisa do Genoma Humano (NHGRI) dos Estados Unidos, caracterizou mais de 20 mil cancros primários abrangendo 33 tipos de cancro.
Os tipos de cancro selecionados para estudo cumprem requisitos tais como ter um mau prognóstico, ter um impacto geral na saúde pública, disponibilidade de amostras com a qualidade e quantidade desejadas, entre outros.
(National Cancer Institute, 2022)

O cancro endométrico do corpo uterino, um dos cancros incluídos no TCGA, é o sétimo tumor maligno mais frequente no mundo e o quarto mais comum na mulher sendo a doença ginecológica maligna mais prevalente, tendo provocado em 2011 mais de 8 mil mortes [2,3].
De todos os cancros do corpo uterino mais de 83% correspondem a carcinomas do endométrio, enquanto apenas 10% dos diagnósticos são classificados como sarcomas [2].
Este tipo de cancro tem ganhando maior atenção por parte da comunidade científica, uma vez que se verificou um aumento da sua incidência com a agravante de que a taxa de sobrevivência aos 5 anos é consideravelmente menor, em comparação com o ano de 1975, passando de 88% para cerca de 84%, em 2006, indicando um aumento na mortalidade [3].
A taxa de sobrevivência está fortemente correlacionada com o estádio da doença aquando do diagnóstico, sendo que para pacientes no estádio inicial se considera curável atingindo cerca de 96% de sobrevivência.
No entanto, para fases mais avançadas e de alto grau, é considerado letal reduzindo drasticamente a taxa de sobrevivência de 96% para 17%.(Costa & Cunha, n.d.)

```{r,echo=FALSE,results= 'markup', fig.cap= "Fig 1- Anatomia do sistema reprodutor feminino (Adaptdado de National Cancer Institute)",fig.align='center'}
image=readJPEG("cancro_endometrico.jpg")

plot(0, 0, type = "n", xlim = c(0, 1), ylim = c(0, 1), xlab = "", ylab = "", axes= FALSE)
rasterImage(image, 0, 0, 1, 1)
```

### 1.2. Objetivo

Tendo em conta o que foi descrito anteriormente, este trabalho tem como objetivo analisar o perfil transcriptómico de células endometeriais do corpo uterino de pacientes diagnosticados com cancro para determinadas condições descritas nos metadados de modo a realizar a análise da expressão diferencial com o intuito de compreender qual o efeito do fator no perfil transcriptómico das células e como esse perfil se traduz na gravidade da doença observada.
Os dados utilizados neste trabalho estão disponíveis em [cbioportal](https://shorturl.at/wJZ34) e estão associados ao projeto "Uterine Corpus Endometrial Carcinoma TCGA PanCancer data".

## 2.Extração dos dados de transcriptómica e respetivos metadados da base de dados

### 2.1. Obtenção dos dados

Com o objetivo de analisar os dados de transcriptómica referente ao carcinoma endométrio do corpo uterino, procedemos à extração da informação que se encontra presente no website cBioPortal, onde se encontram disponibilizados, de forma gratuita, uma grande diversidade de alterações genómicas de vários tipos de cancro, incluindo o cancro selecionado para estudo.
Para esse efeito recorremos ao package TCGAbiolinks, uma vez que este possibilita a interação com a base de dados cBioPortal e apresenta várias funções que possibilitam realizar queries à base de dados filtrando os datasets que se seleciona para proceder, posteriormente, ao seu download.

```{r,results= 'markup'}
query_UCEC = GDCquery(
  project = "TCGA-UCEC",
  data.category = "Transcriptome Profiling", 
  data.type = "Gene Expression Quantification",
  workflow.type = "STAR - Counts"
)


GDCdownload(query=query_UCEC)


rna_seq_UCEC = GDCprepare(query = query, save = TRUE, save.filename = "mRNA_TCGA-UCEC.rda")
rna_seq_UCEC = get(load("mRNA_TCGA-UCEC.rda"))
```

A função GDCquery() é utilizada para realizar a query à base dados.
Nesta função são definidos vários parâmetros que permitem filtrar o data set que posteriormente vai ser descarregado.
O parâmetro "project" corresponde ao id atribuído ao tipo de cancro de modo a apenas considerar a informação disponível referente ao carcinoma endométrio do corpo uterino.
A "data.category" é usado para especificar a categoria de dados que se pretende selecionar, neste caso, como pretendemos realizar a análise da transcriptómica selecionou-se a categoria "Transcriptome Profiling" para selecionar os dados relacionados com o perfil de expressão de genes.
De entre os dados do perfil de expressão de genes restringiu-se apenas aos dados referentes à quantificação da expressão de genes definindo "data.type" como Gene expression quantification.
Por fim, indicou-se o tipo de análise da expressão genética desejada, optando-se por recorrer ao START-Counts.
Este workflow indica que o algoritmo utilizado para a contagem da expressão genética a partir do alinhamento das sequências foi realizada com a ferramenta STAR.

A função GDCdownload() é utilizada para realizar o download dos dados consoante a query realizada e estabelecida na função anterior.
Em seguida, recorreu-se à função GDCprepare() com o intuito de gerar um objeto "SummarizedExperiment" de modo a compilar a informação descarregada num único objeto de modo a facilitar a análise dos dados.
É de notar que a função também permite gravar os dados em formato "rdata" de modo a facilitar o carregamento dos dados através da função load().
É importante referir que a utilização deste workflow permite o download simultaneo quer dos dados da expressão genética quer dos metadados associados às amostras e aos genes.

### 2.2. Análise inicial dos dados

Nesta fase procedeu-se à exploração incial dos dados de forma a perceber a dimensão dos dados correspondente à expressão genética bem como dos metadados.

```{r, echo=TRUE}
# analise da estrutura dos dados descarregados
class(rna_seq_UCEC)
dim(rna_seq_UCEC)
colnames(rna_seq_UCEC)[1:5]
rownames(rna_seq_UCEC)[1:5]


# análise dos metadados
linhas_metadados=SummarizedExperiment::rowData(rna_seq_UCEC)
amostras_metadados = SummarizedExperiment::colData(rna_seq_UCEC)

class(linhas_metadados)
class(amostras_metadados)

dim(linhas_metadados)
dim(amostras_metadados)

colnames(linhas_metadados)[1:5]
colnames(amostras_metadados)[1:5]

```

Através da análise feita acima é possível verificar que o nosso dataset é um objeto "SummarizedExperiment" que possui 60660 linhas e 589 colunas.
Com a extração dos metadados associados as linhas podemos concluir que as linhas do objeto correspondem aos genes, sendo que, para cada gene, existem 10 metadados associados a cada gene incluindo o gene_id que corresponde a um código único utilizado pela base de dados Ensembl para a identificação dos varios genes.
Por outro lado, as colunas possuem 78 metadados que possibilitam a caracterização das 589 amostras utilizadas neste estudo permitindo analisar o impacto que as diferentes características possuem nos dados de expressão genética.
É importante referir que os metadados associados às colunas passam a ter uma apresentação diferente, isto é, as linhas passam a ser identificadas com o id da amostra enquanto no objeto original as linhas são identicadas pelo id do gene.

### 2.3. Preparação e pre-processamento dos dados

Nesta etapa preparamos o dataset para ser, posteriormente, submetido a análise de expressão diferencial e de enriquecimento.
Para esse efeito, optamos por separar os dados referentes à expressão genética e a informação relativa aos metadados do objeto inicial para depois realizar a filtragem dos dados.

```{r extração da informação}
# extração da informação da expressão de genes
geneExp = SummarizedExperiment::assay(rna_seq_UCEC)
```

Com o package SummarizedExperiment armazena-se dados de contagens de sequenciamento de RNA, bem como outros tipos de dados experimentais ômicos, junto com metadados relevantes.
Esses dados de expressão genética extraídos são armazenados na variável geneExp.
A função assay() é usada para extrair a matriz de contagens (ou matriz de expressão) do objeto SummarizedExperiment.
Esta matriz contém os dados numéricos de expressão para cada gene em cada amostra, que são essenciais para análises subsequentes, como normalização, análise de expressão diferencial, e outras análises ômicas.

## 3.Metadados

### 3.1. Pre-processamento e filtragem

Com o intuito de fazer uma filtragem dos metadados, uma vez que é comum a existência de valores omissos, procedeu-se procedeu-se à diminuição do número de colunas associadas aos metadados, eliminando-se as colunas que possuem mais de 10% de valores omissos.
Esta abordagem é realizada para ser mais fácil definir uma estratégia de análise do dataset escolhido.
Retirou-se as colunas dos metadados onde havia mais de 60 elementos como: "not/Not reported/Reported" e/ou "NA.

```{r, echo=TRUE}

# remoção de colunas com mais de 10% de valores omissos
rm_not_reported = which(sapply(amostras_metadados,function(x) sum(x == "not reported", na.rm = TRUE)) > 60)
rm_Not_Reported = which(sapply(amostras_metadados,function(x) sum(x == "Not Reported",na.rm = TRUE)) > 60)
rm_nas = which(sapply(amostras_metadados, function(x) sum(is.na(x))) > 60)
amostras_meta_reduzido = amostras_metadados[, -c(rm_not_reported, rm_Not_Reported, rm_nas)]
dim(amostras_meta_reduzido)
```

Com esta filtragem obteve-se 50 colunas, ao invés das 78 iniciais.É possível realizar uma filtragem ainda mais profunda dos metadados, porém estabeleceu-se nesta fase inicial uma percentagem fixa de valores omissos a eliminar.

### 3.2. Análise Descritiva

```{r, echo=TRUE}
# seleção apenas das colunas de interesse e transformação da coluna figo_stage
amostras_meta_reduzido = amostras_meta_reduzido[,c("vital_status","primary_diagnosis","age_at_index","figo_stage")]
amostras_meta_reduzido$figo_stage = gsub(".*\\b(Stage [VI]+).*", "\\1", amostras_meta_reduzido$figo_stage)

```

### 3.3. Análise Exploratória {.tabset}

#### Estado Vital

```{r, echo=False}
# vital_status
tabela_vital = prop.table(table(amostras_meta_reduzido$vital_status, useNA = "ifany")) *100
barplot(tabela_vital, names.arg= c("Alive","Dead","NAs"), col= "lightblue", ylab="Percentagem",
        main="Estado Vital")
```

#### Diagnóstico Primário

```{r, echo=False}
# primary_diagnosis
tabela_primary = prop.table(table(amostras_meta_reduzido$primary_diagnosis, useNA = "ifany")) * 100
outros = sum(tabela_primary[c(1, 2, 3, 5, 6, 8, 9)])
primary_comprimido = matrix(c(outros, tabela_primary[4], tabela_primary[7]), ncol = 3,
    dimnames = list(NULL, c("Outros", "Endometrioid adenocarcinoma, NOS", "Serous cystadenocarcinoma, NOS")))
labels_primary <- c("Outros", "Endometrioid adenocarcinoma, NOS", "Serous cystadenocarcinoma, NOS")
pie(primary_comprimido, labels = paste(labels_primary, sprintf("%.1f%%", primary_comprimido)),
    col = c('lightgreen', 'lightblue', 'lightpink'), main = "Distribuição de Diagnósticos Primários")

```

#### Estádio Figo

```{r, echo=False}
# figo_stage
tabela_figo = prop.table(table(amostras_meta_reduzido$figo_stage,  useNA = "ifany")) *100
labels_figo = c("Stage I", "Stage II", "Stage III", "Stage IV", "NAs")
pie(tabela_figo, labels = paste(labels_figo, sprintf("%.1f%%", tabela_figo)), col=c('lightblue','lightgreen',
    'yellow','lightpink','orchid'), main= "Distribuição de Estágios de cancro Ginecológico (FIGO)")

```

#### Idade dos Pacientes

```{r, echo=False}
# age_at_index
idade_pacientes = amostras_meta_reduzido$age_at_index
summary(idade_pacientes)
#par(mfrow = c(2, 1))
boxplot(idade_pacientes,horizontal=T, col = "purple", main='Histograma da idade dos pacientes')
hist(idade_pacientes, xlab = 'Idade dos Pacientes', ylab = 'Frequência', main = 'Histograma da Idade dos Pacientes',
     col='lightblue')

```

#############Não está feito \################

```{r, echo=TRUE}
# criar vetor logica em que diz que linhas é que possuem grade diferente de na
coluna=!is.na(meta_UCEC$paper_tumor_grade) 

```

```{r, echo=TRUE}
# seleciona apenas as linhas que tem grade
meta=meta_UCEC[coluna,c("paper_tumor_grade","paper_age","disease_type")] 
meta$disease_type
table(meta_UCEC[rownames(meta),"paper_tumor_grade"]) # confirmar que os pacientes selecionados tem um valor de grade atribuido na tabela de metadados original
head(meta)

```

```{r, echo=TRUE}
summary(meta$paper_age)
boxplot(meta$paper_age,horizontal=T)

```

```{r, echo=TRUE}
anova=aov(meta$paper_age~meta$paper_tumor_grade)
summary(anova)

```

```{r, echo=TRUE}
TukeyHSD(anova)

```

```{r, echo=TRUE}
boxplot(meta$paper_age~meta$paper_tumor_grade,horizontal=T)
#verificaçáo da dimensão do dataframe meta após selação de apenas as linhas com informação relativa ao grade
sum(table(meta_UCEC$paper_tumor_grade))
dim(meta)

```

```{r, echo=TRUE}
#criação do data frame de expressão apenas para os pacientes com informação relativa ao grade
exp_grade=geneExp[,rownames(meta)]
dim(exp_grade)

```

```{r, echo=TRUE}
row.names(meta_UCEC[,"paper_tumor_grade"])
select=meta_UCEC$paper_tumor_grade
row_names=rownames(select)
```

```{r, echo=TRUE}
#nomes das linhas
names(meta_UCEC)
#extrair componentes de um objeto por nome (através de colunas)
meta_UCEC$patient
meta_UCEC$paper_vital_status

```

```{r, echo=TRUE}
# Extrair apenas a palavra "Stage" e os números romanos
figo_stage <- gsub(".*\\b(Stage [VI]+).*", "\\1", metadata_matriz_clean$figo_stage)

```

```{r, echo=TRUE}
# Visualizar o resultado
print(metadata_matriz_clean$figo_stage)

```

################################## 

# 2ª Parte

################################## 

# Bibliografia

1.  Sung H, Ferlay J, Siegel RL, Laversanne M, Soerjomataram I, Jemal A, Bray F. Global Cancer Statistics 2020: GLOBOCAN Estimates of Incidence and Mortality Worldwide for 36 Cancers in 185 Countries.
    CA Cancer J Clin.
    2021 May;71(3):209-249.
    \doi: 10.3322/caac.21660.

2.  Creasman WT, Odicino F, Maisonneuve P, Quinn MA, Beller U, Benedet JL, Heintz A, Ngan H, Pecorelli S. Carcinoma of the Corpus Uteri.
    Int J Gynaecol Obstet.
    2006 Nov;95 Suppl 1:S105-S143.
    \doi: 10.1016/S0020-7292(06)60031-3.

3.  Leslie KK, Thiel KW, Goodheart MJ, De Geest K, Jia Y, Yang S. Endometrial cancer.
    Obstet Gynecol Clin North Am.
    2012 Jun;39(2):255-68.
    \doi: 10.1016/j.ogc.2012.04.001.
